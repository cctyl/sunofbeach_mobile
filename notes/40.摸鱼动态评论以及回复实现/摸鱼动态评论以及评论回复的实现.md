# 摸鱼动态评论以及评论回复的实现

### 简介

源码地址：https://github.com/cctyl/sunofbeach_mobile

之前已经完成评论输入框，以及输入按钮的界面实现。现在我们要对其功能进行实现。

这里评论分两个部分

- 一、评论摸鱼动态
- 二、回复摸鱼动态评论的评论



### 评论摸鱼动态

看下效果：

![评论摸鱼动态](摸鱼动态评论以及评论回复的实现.assets/评论摸鱼动态.gif)

当我们点击回复按钮时，展开评论列表以及输入框。输入内容后直接调用接口就可以啦，是不是非常简单。

点一下就发送，发送完清空输入框，然后弹出一个提示，最后更新摸鱼动态列表。

其实这种更新做法不太优雅，应该是把我们新增的评论自己push到列表中，但是因为我们无法获得评论id，后续会出现问题，所以直接更新了整个列表。

另外，评论按钮上面的数字也要同步更新（上方的截图漏了）

代码如下：

```js
//接口部分
   /**
     * 评论摸鱼动态
     * POST /ct/moyu/comment
     * comment: {
          momentId: '',
          content: ''
        }
     */
    sendMoyuComment(momentId,content){
        return ajax(`/ct/moyu/comment`, {
            momentId,
            content
        }, 'POST')
    }


//发送逻辑
           /**
             * 发表评论
             * @param commentStr
             */
            async sendMoyuComment(momentItem) {
                console.log("当前的评论内容是：")
                console.log(momentItem)
                let result = await api.sendMoyuComment(momentItem.id, momentItem.commentStr);
                if (result.success) {
                    this.$toast.success('操作成功！');
                    momentItem.commentStr = ''
                    //需要更新回复列表
                    this.getMomentCommontList(momentItem);
                } else {
                    this.$toast.fail('发送失败！' + result.message);
                }
            },

```



### 回复摸鱼动态评论的评论

效果如下：

![回复摸鱼动态评论的评论](摸鱼动态评论以及评论回复的实现.assets/回复摸鱼动态评论的评论.gif)

逻辑是这样的，我们挪用了文章评论里的组件，偷懒使用弹出层进行评论，点击评论后展开弹出一个弹出层，注意弹出层中包含一个被回复的用户名。点击评论后，关闭弹出层，清空输入框，刷新评论列表。

这里稍微有一点复杂，我们拿一个案例来解释。

![image-20230507161325844](摸鱼动态评论以及评论回复的实现.assets/image-20230507161325844.png)

这个摸鱼动态的评论的数据结构是：

```js
{
    content:"刚刚更新了一下博客...",
    commentItemList:[
        {
            content:"版本差异挺大的....",
            subItem:[
                {
                    content:"回复拉大锯 我一直用"
                },
                {
                    content:"回复 断点 你没有使用新的库"
                }
            ]
        }
    ]
}
```

最外层的是一个MoyuMoment 对象，而内层开始就是一级评论对象。一级评论对象中，有两个子评论对象。总共有三层。

回到图上，图上有三个回复按钮，你觉得他们分别回复的是 一级评论对象，还是子评论对象，还是MoyuMoment 对象？

实际上，这三个按钮回复的都是 一级评论对象，“版本差异挺大的”。 

也就是说，虽然下面的两个子评论，看起来是回复关系，实际上是平级关系。

现在我们知道了它的层级结构之后，到时候取commentId 时，就千万不要取错了。取错之后，虽然后端依然会返回评论成功，但是实际上还是评论失败的。

代码大概的贴一下：

```js
//api
    /**
     * 回复评论
     * @param content
     * @param momentId
     * @param targetUserId
     * @param commentId
     * @returns {Promise<unknown>}
     */
    sendMoyuSubComment(
                   content,
                   momentId,
                   targetUserId,
                   commentId
               ) {

        return ajax(`/ct/moyu/sub-comment`, {
            content,
            momentId,
            targetUserId,
            commentId

        }, 'POST')
    },

        

//data部分新增变量
         		showCommentPanel:false,//是否展示评论弹窗
                popCommentStr:'',//弹出回复框数据绑定
                popCommentType:0,//评论类型，是一级评论，还是子评论
                popCommentObj:{},//当前将要回复的评论对象
                popCommentTargetUserId:0,//将要回复的用户id
                commentMomentItem:{},//当前正在被评论的摸鱼动态对象
//摸鱼逻辑：
      		/**
             * 展示评论填写框
             */
            openCommentPanel(commentObj,type,targetUserId,targetUserName,momentItem){
                //清空旧数据
                this.popCommentStr = ""
                //打开弹出层
                this.showCommentPanel = true
                this.popCommentTargetUserId = targetUserId
                this.commentMomentItem = momentItem
                this.popCommentObj = commentObj;
                if (!this.isLogin()) {
                    return
                }

                /**
                 * 4 一级评论
                 *
                 */
                this.popCommentType = type
                this.commentPlaceText=`回复 @${targetUserName}`
            },

            /**
             * 提交评论
             */
            async submitComment() {

               let result = await api.sendMoyuSubComment(
                   this.popCommentStr,
                   this.popCommentObj.momentId,
                   this.popCommentTargetUserId,
                   this.popCommentObj.id
               )
                console.log(result)

                if (result.code === 10000) {
                    this.$notify.success(result.message)

                    //清空评论框
                    this.popCommentStr = ''
                    //关闭弹窗
                    this.showCommentPanel = false
                    this.popCommentObj={}

                    //更新评论列表
                    this.getMomentCommontList(this.commentMomentItem);
                } else {
                    this.$notify.warn(result.message)
                }
            },
```

